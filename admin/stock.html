<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tồn Kho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* CSS CƠ BẢN (GIỮ NGUYÊN) */
        body { background-color: #f0f2f5; }
        #sidebar { min-width: 250px; max-width: 250px; background-color: #ffffff; height: 100vh; position: fixed; top: 0; left: 0; box-shadow: 0 0 10px rgba(0,0,0,0.05); padding-top: 20px; }
        #content { margin-left: 250px; padding: 30px; }
        .sidebar-header h3 { color: #007bff; font-weight: bold; }
        .sidebar-list a { padding: 10px 20px; color: #495057; display: block; text-decoration: none; transition: all 0.2s; }
        .sidebar-list a:hover,
        /* Đặt active class cho trang hiện tại */
        .sidebar-list a[href='stock.html'] { background: #e9f2ff; color: #007bff; border-left: 5px solid #007bff; padding-left: 15px; }
        .sidebar-list .fa-icon { width: 25px; }
        
        /* Bổ sung CSS cho trạng thái tồn kho */
        .badge.bg-warning-stock { background-color: #ffc107 !important; color: #343a40 !important; }
        .badge.bg-danger-stock { background-color: #dc3545 !important; color: #fff !important; }
        .badge.bg-success-stock { background-color: #28a745 !important; color: #fff !important; }
        .table td, .table th { vertical-align: middle; }
    </style>
</head>
<body>

<div class="d-flex">
    <div id="sidebar">
        <div class="sidebar-header text-center mb-4"><h3><i class="fas fa-bicycle"></i> Bike Admin</h3></div>
        <ul class="list-unstyled sidebar-list">
            <li><a href="dashboard.html"><i class="fas fa-tachometer-alt fa-icon"></i> Trang chủ</a></li>
            <li><a href="bikes.html"><i class="fas fa-motorcycle fa-icon"></i> Quản lý Xe Đạp</a></li>
            <li><a href="categories.html"><i class="fas fa-sitemap fa-icon"></i> Loại Xe</a></li>
            <li><a href="orders.html"><i class="fas fa-receipt fa-icon"></i> Đơn hàng</a></li>
            <li><a href="customers.html"><i class="fas fa-users fa-icon"></i> Khách hàng</a></li>
            <li><a href="stock.html" class="active"><i class="fas fa-warehouse fa-icon"></i> Tồn kho</a></li>
            <li><a href="stock_in.html"><i class="fas fa-truck-loading fa-icon"></i> Nhập Hàng Mới</a></li>
            <li><a href="price_management.html"><i class="fas fa-tags fa-icon"></i> Quản lý Giá bán</a></li>
            <li class="mt-4"><a href="admin-login.html"><i class="fas fa-sign-out-alt fa-icon"></i> Đăng xuất</a></li>
            <li><a href="/BikeShop-main/index.html"><i class="fas fa-home fa-icon"></i> Về trang chủ</a></li>
        </ul>
    </div>
    <div id="content" class="w-100">
        <nav class="navbar navbar-light bg-white mb-5 rounded shadow-sm">
            <div class="container-fluid">
                <span class="navbar-brand h1 mb-0 text-primary">Quản Lý Tồn Kho</span>
            </div>
        </nav>
        
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs card-header-tabs" id="stockTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active fw-bold" id="inventory-tab" data-bs-toggle="tab" href="#inventory" role="tab" aria-controls="inventory" aria-selected="true">Tồn Kho Hiện Tại & Cảnh Báo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-bold" id="report-tab" data-bs-toggle="tab" href="#report" role="tab" aria-controls="report" aria-selected="false">Báo Cáo Xuất-Nhập-Tồn</a>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content" id="stockTabsContent">
                    
                    <div class="tab-pane fade show active" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                        
                        <div class="alert alert-warning" role="alert">
                          <i class="fas fa-exclamation-triangle"></i> Có **<span id="lowStockCount"></span>** mẫu xe đang dưới mức tồn kho tối thiểu (10 chiếc).
                        </div>
                        
                        <h6 class="fw-bold mb-3 mt-4">Tra cứu Tồn kho</h6>
                       <div class="row g-3 mb-4">
    <div class="col-md-5">
        <input type="text" class="form-control" id="stockSearchInput" placeholder="Tìm theo ID hoặc Tên Xe...">
    </div>
    <div class="col-md-3">
        <select class="form-select" id="stockCategoryFilter">
            <option selected value="">Tất cả Loại xe</option>
            <option value="Địa Hình">Địa Hình</option>
            <option value="Đô Thị">Đô Thị</option>
            <option value="Đua">Đua</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="stockAlertFilter">
            <option selected value="">Tất cả Trạng thái</option>
            <option value="danger">Cần nhập gấp</option>
            <option value="warning">Cảnh báo</option>
            <option value="safe">An toàn</option>
        </select>
    </div>
    <div class="col-md-1">
        <button class="btn btn-primary w-100" id="filterStockButton"><i class="fas fa-search"></i></button>
    </div>
    <div class="col-md-1">
        <button class="btn btn-secondary w-100" id="resetStockFilterButton"><i class="fas fa-redo"></i></button>
    </div>
</div>
                        <h6 class="fw-bold mb-3 mt-4">Danh sách Chi tiết</h6>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID Xe</th>
                                    <th>Tên Xe</th>
                                    <th>Loại</th>
                                    <th class="text-end">Số lượng Tồn</th>
                                    <th class="text-end">Tồn tối thiểu</th>
                                    <th>Ngày nhập gần nhất</th> <th class="text-center">Trạng thái</th>
                                    <th class="text-center">Hành động</th> 
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                </tbody>
                        </table>
                            
                    </div>
                    
                    <div class="tab-pane fade" id="report" role="tabpanel" aria-labelledby="report-tab">
                        <h5 class="fw-bold mb-4">Báo cáo Xuất - Nhập - Tồn chi tiết</h5>
                        
                       <div class="row g-3 mb-4">
    <div class="col-md-3">
        <label class="form-label text-muted">Từ ngày:</label>
        <input type="date" class="form-control" id="reportStartDate">
    </div>
    <div class="col-md-3">
        <label class="form-label text-muted">Đến ngày:</label>
        <input type="date" class="form-control" id="reportEndDate">
    </div>
    <div class="col-md-4">
        <label class="form-label text-muted">Mã/Tên Xe:</label>
        <input type="text" class="form-control" id="reportItemSearch" placeholder="ID/Tên Xe">
    </div>
    <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-success w-100" id="filterReportButton"><i class="fas fa-file-export"></i></button>
    </div>
    <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-secondary w-100" id="resetReportFilterButton"><i class="fas fa-redo"></i></button>
    </div>
</div>

                        <div class="row mb-5">
                            <div class="col-md-4">
                                <div class="card text-white bg-primary shadow-sm">
                                    <div class="card-body">
                                        <h6 class="card-title">Tổng Nhập Trong Kỳ</h6>
                                        <p class="card-text fs-4 fw-bold" id="totalIn">150</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-white bg-danger shadow-sm">
                                    <div class="card-body">
                                        <h6 class="card-title">Tổng Xuất Trong Kỳ</h6>
                                        <p class="card-text fs-4 fw-bold" id="totalOut">95</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-white bg-success shadow-sm">
                                    <div class="card-body">
                                        <h6 class="card-title">Tồn Cuối Kỳ</h6>
                                        <p class="card-text fs-4 fw-bold" id="endStock">55</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="fw-bold mb-3">Lịch sử Xuất - Nhập</h6>
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Ngày</th>
                                    <th>Mã Xe</th>
                                    <th>Tên Xe</th>
                                    <th class="text-center">Loại Thao Tác</th>
                                    <th class="text-end">Số Lượng</th>
                                    <th>Ghi Chú</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const inventoryTableBody = document.getElementById('inventoryTableBody');
    const reportTableBody = document.getElementById('reportTableBody');
    
    // BIẾN CHO TỒN KHO (Giữ nguyên)
    const stockSearchInput = document.getElementById('stockSearchInput');
    const stockCategoryFilter = document.getElementById('stockCategoryFilter');
    const stockAlertFilter = document.getElementById('stockAlertFilter');
    const filterStockButton = document.getElementById('filterStockButton');
    const resetStockFilterButton = document.getElementById('resetStockFilterButton'); 
    const lowStockCount = document.getElementById('lowStockCount');
    
    // BIẾN CHO BÁO CÁO (Giữ nguyên)
    const reportStartDate = document.getElementById('reportStartDate');
    const reportEndDate = document.getElementById('reportEndDate');
    const reportItemSearch = document.getElementById('reportItemSearch'); 
    const reportFilterButton = document.getElementById('filterReportButton'); 
    const resetReportFilterButton = document.getElementById('resetReportFilterButton'); 

    // Dữ liệu mẫu TỒN KHO ĐÃ ĐỒNG BỘ
    let stockData = [
        { id: '#001', name: 'Xe Đạp Đường Phố Touring TRINX Free 2.2 – Phanh Đĩa, Bánh 700C', category: 'Xe đạp đường phố', current: 12, min: 10, lastImportDate: '2025-11-15' },
        { id: '#002', name: 'Xe Đạp Đường Trường Road JAVA Auriga R5 - Phanh Đĩa, Bánh 700C', category: 'Xe đạp đua', current: 5, min: 10, lastImportDate: '2025-10-20' },
        { id: '#003', name: 'Xe Đạp Đường Phố Touring LIV Alight 4 Disc - 2025', category: 'Xe đạp đường phố', current: 8, min: 10, lastImportDate: '2025-11-12' },
        { id: '#004', name: 'Xe Đạp Đường Phố Fixed Gear VINBIKE Megatron – Bánh 700C', category: 'Xe đạp đường phố', current: 25, min: 5, lastImportDate: '2025-11-01' },
        { id: '#005', name: 'Xe Đạp Đường Phố Touring JAVA Wahoo City - Phanh Đĩa, Bánh 700C', category: 'Xe đạp đường phố', current: 2, min: 10, lastImportDate: '2025-11-05' },
        { id: '#006', name: 'Phụ kiện: Khóa chống trộm', category: 'Phụ kiện', current: 50, min: 30, lastImportDate: '2025-11-05' },
        { id: '#007', name: 'Xe Đạp Đường Trường Road JAVA Siluro6-TOP-RX', category: 'Xe đạp đua', current: 15, min: 10, lastImportDate: '2025-11-05' },
    ];

    // Dữ liệu mẫu BÁO CÁO XUẤT-NHẬP ĐÃ ĐỒNG BỘ
    const reportData = [
        { date: '2025-11-15', id: '#001', name: 'Xe Đạp Đường Phố Touring TRINX Free 2.2', type: 'NHẬP', quantity: 20, note: 'Nhập hàng đợt 3' },
        { date: '2025-11-12', id: '#003', name: 'Xe Đạp Đường Phố Touring LIV Alight 4 Disc', type: 'XUẤT', quantity: 5, note: 'Đơn hàng #DH015' },
        { date: '2025-11-10', id: '#002', name: 'Xe Đạp Đường Trường Road JAVA Auriga R5', type: 'XUẤT', quantity: 15, note: 'Đơn hàng #DH010' },
        { date: '2025-11-05', id: '#005', name: 'Xe Đạp Đường Phố Touring JAVA Wahoo City', type: 'NHẬP', quantity: 10, note: 'Nhập hàng khẩn cấp' },
        { date: '2025-11-01', id: '#001', name: 'Xe Đạp Đường Phố Touring TRINX Free 2.2', type: 'NHẬP', quantity: 10, note: 'Nhập hàng đầu tháng' },
    ];
    
    // Hàm chuyển đổi định dạng ngày DD/MM/YYYY
    function formatDateDisplay(dateStr) {
        if (!dateStr || dateStr.length < 10) return '';
        const parts = dateStr.split('-');
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    
    function getStatusClass(status) {
        if (status === 'Cần nhập gấp') return 'bg-danger-stock';
        if (status === 'Cảnh báo') return 'bg-warning-stock';
        return 'bg-success-stock';
    }

    // 1. Hàm Render Bảng Tồn Kho
    function renderInventory(list = stockData) {
        inventoryTableBody.innerHTML = '';
        let lowCount = 0;

        list.forEach(item => {
            const status = item.current < item.min * 0.5 ? 'Cần nhập gấp' : (item.current < item.min ? 'Cảnh báo' : 'An toàn');
            const statusClass = getStatusClass(status);
            
            if (status !== 'An toàn') {
                lowCount++;
            }
            
            const actionBtn = (status === 'Cần nhập gấp' || status === 'Cảnh báo')
                ? `<a href="stock_in.html?product_id=${item.id}" class="btn btn-sm btn-danger text-white"><i class="fas fa-truck"></i> Nhập Hàng</a>`
                : '';
            
            const importDate = item.lastImportDate ? formatDateDisplay(item.lastImportDate) : 'N/A'; // HIỂN THỊ NGÀY

            inventoryTableBody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td class="text-end fw-bold">${item.current}</td>
                    <td class="text-end">${item.min}</td>
                    <td>${importDate}</td> 
                    <td class="text-center"><span class="badge ${statusClass}">${status}</span></td>
                    <td class="text-center">${actionBtn}</td>
                </tr>
            `);
        });
        lowStockCount.textContent = lowCount;
    }

    // 2. Hàm Render Bảng Báo Cáo Xuất-Nhập-Tồn
    function renderReport(list = reportData) {
        reportTableBody.innerHTML = '';
        let totalIn = 0;
        let totalOut = 0;

        list.forEach(item => {
            const typeClass = item.type === 'NHẬP' ? 'text-primary fw-bold' : 'text-danger fw-bold';
            
            if (item.type === 'NHẬP') {
                totalIn += item.quantity;
            } else {
                totalOut += item.quantity;
            }

            reportTableBody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${formatDateDisplay(item.date)}</td>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td class="text-center ${typeClass}">${item.type}</td>
                    <td class="text-end">${item.quantity}</td>
                    <td>${item.note}</td>
                </tr>
            `);
        });
        
        document.getElementById('totalIn').textContent = totalIn;
        document.getElementById('totalOut').textContent = totalOut;
        
        let currentTotalStock = stockData.reduce((sum, item) => sum + item.current, 0);
        document.getElementById('endStock').textContent = currentTotalStock;
    }

    // --- LOGIC LỌC VÀ ĐẶT LẠI ---

    // Lọc Tồn Kho
    filterStockButton.addEventListener('click', function() {
        const keyword = stockSearchInput.value.toLowerCase();
        const category = stockCategoryFilter.value;
        const alertStatus = stockAlertFilter.value;

        const filteredList = stockData.filter(item => {
            const currentStatus = item.current < item.min * 0.5 ? 'danger' : (item.current < item.min ? 'warning' : 'safe');
            
            const matchesKeyword = !keyword || 
                item.id.toLowerCase().includes(keyword) || 
                item.name.toLowerCase().includes(keyword);
            
            const matchesCategory = !category || item.category === category;
            const matchesAlert = !alertStatus || (alertStatus === currentStatus);
            
            return matchesKeyword && matchesCategory && matchesAlert;
        });

        renderInventory(filteredList);
    });
    
    // ĐẶT LẠI TỒN KHO (MỚI)
    resetStockFilterButton.addEventListener('click', function() {
        stockSearchInput.value = '';
        stockCategoryFilter.value = '';
        stockAlertFilter.value = '';
        renderInventory();
    });

    // Lọc Báo Cáo
    reportFilterButton.addEventListener('click', function() {
        const start = reportStartDate.value;
        const end = reportEndDate.value;
        const keyword = reportItemSearch.value.toLowerCase();

        const filteredReport = reportData.filter(item => {
            const itemDate = item.date;

            const matchesDate = (!start || itemDate >= start) && (!end || itemDate <= end);
            
            const matchesKeyword = !keyword || 
                item.id.toLowerCase().includes(keyword) || 
                item.name.toLowerCase().includes(keyword);
            
            return matchesDate && matchesKeyword;
        });

        renderReport(filteredReport);
    });
    
    // ĐẶT LẠI BÁO CÁO (MỚI)
    resetReportFilterButton.addEventListener('click', function() {
        reportStartDate.value = '';
        reportEndDate.value = '';
        reportItemSearch.value = '';
        renderReport();
    });
    
    // --- KHỞI TẠO ---
    renderInventory();
    renderReport();
});
</script>
</body>
</html>