<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BikePro Admin ‚Äî Qu·∫£n l√Ω xe ƒë·∫°p (Full)</title>
  <style>
    :root{
      --bg:#071018; --panel:#0f1720; --muted:#9aa4b2; --accent:#00b4d8; --danger:#ff5c5c;
      --card:#0c1217; --glass:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#05070a,#071018);color:#e6eef6}
    /* login */
    .center-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .login-card{width:420px;background:linear-gradient(180deg,#07121a,#081724);padding:22px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
    .brand{font-weight:800;color:var(--accent);font-size:20px;margin-bottom:8px}
    label{display:block;margin-top:10px;color:var(--muted);font-size:13px}
    input[type="text"],input[type="password"],input[type="number"],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef6;margin-top:6px}
    .row{display:flex;gap:8px;margin-top:12px}
    .btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;background:transparent;color:var(--muted)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#66e0ff);color:#012}
    .btn.warn{background:rgba(255,201,71,0.12);color:#ffd89b}
    .btn.danger{background:linear-gradient(90deg,#ff7a7a,#ff5c5c);color:#111}
    .small{font-size:13px;color:var(--muted);margin-top:8px}
    /* app layout */
    .app{display:none;min-height:100vh}
    .sidebar{width:260px;background:linear-gradient(180deg,var(--panel),#071018);padding:20px;border-right:1px solid rgba(255,255,255,0.02);position:fixed;inset:0 auto auto 0}
    .nav{list-style:none;padding:0;margin-top:12px}
    .nav button{width:100%;text-align:left;padding:10px;border:0;background:transparent;border-radius:8px;color:var(--muted);cursor:pointer;margin-bottom:6px}
    .nav button.active{background:rgba(0,180,216,0.08);color:var(--accent)}
    .main{margin-left:280px;padding:22px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);color:var(--muted);text-align:left}
    th{background:rgba(255,255,255,0.02)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .table-scroll{max-height:420px;overflow:auto}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .badge.open{background:rgba(0,255,187,0.06);color:#8fffe3}
    .badge.lock{background:rgba(255,92,92,0.08);color:#ffb4b4}
    .muted{color:var(--muted)}
    /* product sub-tabs */
    .subtabs{display:flex;gap:8px;margin-bottom:12px}
    .subtabs button{padding:8px 10px;border-radius:8px;border:0;background:transparent;color:var(--muted);cursor:pointer}
    .subtabs button.active{background:rgba(255,255,255,0.02);color:var(--accent)}
    /* modal */
    #modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6)}
    #modalCard{width:820px;max-width:95%;background:var(--card);padding:18px;border-radius:12px;max-height:90vh;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
    /* responsive */
    @media(max-width:900px){.sidebar{display:none}.main{margin-left:0;padding:12px}}
    code{background:rgba(255,255,255,0.02);padding:2px 6px;border-radius:6px;color:var(--muted)}
    /* --- CƒÉn ch·ªânh b·∫£ng s·∫£n ph·∫©m cho ƒë·∫πp --- */
#tblProducts {
  width: 100%;
  border-collapse: collapse;
}

#tblProducts th, 
#tblProducts td {
  padding: 8px 10px;
  text-align: left;
  vertical-align: middle;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

/* Gi·ªõi h·∫°n ƒë·ªô r·ªông v√† x·ª≠ l√Ω xu·ªëng d√≤ng */
#tblProducts td:nth-child(3) { /* C·ªôt T√™n s·∫£n ph·∫©m */
  max-width: 250px;
  white-space: normal;
  word-wrap: break-word;
  line-height: 1.4em;
}

/* CƒÉn gi·ªØa c√°c c·ªôt s·ªë */
#tblProducts td:nth-child(1),
#tblProducts td:nth-child(7),
#tblProducts td:nth-child(8) {
  text-align: center;
}

/* CƒÉn gi·ªØa n√∫t h√†nh ƒë·ªông */
#tblProducts td:last-child {
  text-align: center;
}

/* Gi·ªõi h·∫°n chi·ªÅu r·ªông c·ªßa b·∫£ng ƒë·ªÉ kh√¥ng b·ªã k√©o d√†i */
#tblProducts th:nth-child(3),
#tblProducts td:nth-child(3) {
  width: 25%;
}

/* Th√™m hi·ªáu ·ª©ng hover */
#tblProducts tr:hover {
  background-color: rgba(255,255,255,0.03);
}

/* C·∫£i thi·ªán n√∫t */
.btn {
  padding: 4px 8px;
  font-size: 13px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.2s;
}
.btn:hover {
  opacity: 0.85;
}
/* --- T√πy ch·ªânh √¥ dropdown (select) --- */
select,
#filterType {
  appearance: none;                /* ·∫®n giao di·ªán m·∫∑c ƒë·ªãnh */
  -webkit-appearance: none;
  -moz-appearance: none;

  background-color: #1b1b1b;       /* N·ªÅn t·ªëi */
  color: #f5f5f5;                  /* Ch·ªØ s√°ng */
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 14px;
  width: 220px;
  cursor: pointer;
  transition: all 0.25s ease;
  outline: none;
}

/* Khi hover ho·∫∑c focus */
select:hover,
#filterType:hover {
  border-color: #4fc3f7;
}
select:focus,
#filterType:focus {
  border-color: #03a9f4;
  box-shadow: 0 0 6px #03a9f4;
}

/* --- T√πy ch·ªânh ph·∫ßn danh s√°ch b√™n trong --- */
select option,
#filterType option {
  background-color: #1e1e1e;   /* N·ªÅn danh s√°ch */
  color: #f0f0f0;              /* Ch·ªØ tr·∫Øng */
  padding: 8px;
}

/* Khi r√™ chu·ªôt v√†o 1 l·ª±a ch·ªçn */
select option:hover,
#filterType option:hover {
  background-color: #4fc3f7;
  color: #000;
}

/* --- T·∫°o icon m≈©i t√™n ƒë·∫πp --- */
#filterType {
  background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23f5f5f5' viewBox='0 0 16 16'><path d='M1.5 5l6.5 6 6.5-6z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 14px;
  padding-right: 30px; /* ch·ª´a kho·∫£ng cho m≈©i t√™n */
}


  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginWrap" class="center-wrap">
    <div class="login-card">
      <div style="text-align:center;margin-bottom:8px">
        <div class="brand">BikePro Store ‚Äî Admin</div>
        <div class="small">Giao di·ªán qu·∫£n tr·ªã (Dark).</div>
      </div>

      <label>T√™n ƒëƒÉng nh·∫≠p ho·∫∑c email</label>
      <input id="username" type="text" value="admin" />

      <label>M·∫≠t kh·∫©u</label>
      <input id="password" type="password" value="admin" />

      <div class="row" style="justify-content:flex-start;margin-top:12px">
        <button id="btnLogin" class="btn primary">ƒêƒÉng nh·∫≠p</button>
        <button id="demoLogin" class="btn">Demo</button>
        <button id="btnRestore" class="btn warn">Kh√¥i ph·ª•c Admin</button>
      </div>

      <div id="loginMsg" class="small muted"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="app" aria-hidden="true">
    <aside class="sidebar">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-weight:800;color:var(--accent);font-size:18px">BikePro Store</div>
      </div>

      <ul class="nav" id="menu">
        <li><button data-view="dashboard" class="active">T·ªïng quan</button></li>
        <li><button data-view="users">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</button></li>
        <li><button data-view="types">Lo·∫°i xe ƒë·∫°p</button></li>
        <li><button data-view="products">S·∫£n ph·∫©m</button></li>
        <!-- top-level shortcuts kept, but main product features are inside products tab -->
        <li><button data-view="settings">C√†i ƒë·∫∑t</button></li>
      </ul>

      <div style="margin-top:18px;font-size:13px;color:var(--muted)">ƒêƒÉng nh·∫≠p d∆∞·ªõi quy·ªÅn: <strong id="who">Admin</strong></div>
      <div style="margin-top:8px"><button id="btnLogout" class="btn">ƒêƒÉng xu·∫•t</button></div>
      <div style="margin-top:12px;font-size:12px;color:var(--muted)">BikePro ‚Ä¢ Qu·∫£n tr·ªã c·ª≠a h√†ng xe ƒë·∫°p</div>
    </aside>

    <main class="main">
      <header>
        <h2 id="viewTitle">T·ªïng quan</h2>
        <div class="small muted">B·∫£ng ƒëi·ªÅu khi·ªÉn qu·∫£n l√Ω - BikePro Store</div>
      </header>

      <div id="views">
  </tbody>
</table>
        <!-- Dashboard -->
        <section data-view="dashboard">
          <div class="card">
            <h3 style="color:#dff7ff">T·ªïng quan nhanh</h3>
            <div style="display:flex;gap:12px;margin-top:12px">
              <div class="card" style="flex:1">
                <div class="small muted">T·ªïng m·∫´u xe</div>
                <div id="statProducts" style="font-size:20px;font-weight:700;color:var(--accent)">0</div>
              </div>
              <div class="card" style="flex:1">
                <div class="small muted">T·ªìn kho t·ªïng</div>
                <div id="statStock" style="font-size:20px;font-weight:700;color:#ffd166">0</div>
              </div>
              <div class="card" style="flex:1">
                <div class="small muted">ƒê∆°n h√†ng h√¥m nay</div>
                <div id="statOrders" style="font-size:20px;font-weight:700;color:#9be7ff">0</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Users -->
        <section data-view="users" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>Danh s√°ch kh√°ch h√†ng / ng∆∞·ªùi d√πng</h3>
              <div class="small muted">Xem, reset m·∫≠t kh·∫©u, kho√°/m·ªü kho√°</div>
            </div>

            <div class="toolbar" style="margin-top:12px">
              <input id="searchUser" placeholder="T√¨m theo t√™n ho·∫∑c email" />
              <button class="btn" id="btnRefreshUsers">L√†m m·ªõi</button>
              <button class="btn primary" id="btnAddUser">Th√™m ng∆∞·ªùi d√πng</button>
            </div>

            <div class="table-scroll">
              <table id="tblUsers">
                <thead><tr><th>STT</th><th>T√™n</th><th>Email</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Types -->
        <section data-view="types" style="display:none">
          <div class="card">
            <h3>Qu·∫£n l√Ω lo·∫°i xe ƒë·∫°p</h3>
            <div class="toolbar" style="margin-top:12px">
              <input id="typeName" placeholder="T√™n lo·∫°i m·ªõi (v√≠ d·ª•: Xe ƒë·∫°p ƒë·ªãa h√¨nh)" />
              <button class="btn primary" id="btnAddType">Th√™m lo·∫°i</button>
            </div>
            <div class="table-scroll" style="margin-top:8px">
              <table id="tblTypes"><thead><tr><th>STT</th><th>T√™n lo·∫°i</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </section>

        <!-- Products (main) -->
        <section data-view="products" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h3>Qu·∫£n l√Ω s·∫£n ph·∫©m (Xe ƒë·∫°p)</h3>
              <div class="small muted">C√°c ch·ª©c nƒÉng li√™n quan s·∫£n ph·∫©m: danh s√°ch, nh·∫≠p h√†ng, gi√° b√°n, t·ªìn kho, ƒë∆°n h√†ng.</div>
            </div>

            <div class="subtabs" style="margin-top:12px">
              <button data-sub="list" class="active">Danh s√°ch</button>
              <button data-sub="imports">Nh·∫≠p h√†ng</button>
              <button data-sub="pricing">Gi√° b√°n</button>
              <button data-sub="stock">T·ªìn kho</button>
              <button data-sub="orders">ƒê∆°n h√†ng</button>
            </div>

            <!-- Subviews -->
            <div id="subviews">
              <!-- List -->
              <div data-subview="list">
                <div class="toolbar" style="margin-top:8px">
                  <select id="filterType"><option value="">-- L·ªçc theo lo·∫°i --</option></select>
<div class="search-bar" style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
  <input id="searchProd" type="text" placeholder="T√¨m theo t√™n ho·∫∑c m√£" style="flex:1">
  <button id="btnSearchProd" class="btn primary">üîç T√¨m</button>
    <button id="btnShowAll" class="btn warn">Hi·ªÉn th·ªã t·∫•t c·∫£</button>

  <button id="btnAddProd" class="btn">‚ûï Th√™m xe ƒë·∫°p</button>
</div>

                </div>
                <div class="table-scroll" style="margin-top:8px">
                  <table id="tblProducts"><thead><tr><th>STT</th><th>M√£</th><th>T√™n</th><th>Lo·∫°i</th><th>Gi√° v·ªën</th><th>Gi√° b√°n</th><th>T·ªìn</th><th>·∫®n</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody></tbody></table>
                </div>
              </div>

              <!-- Imports -->
              <div data-subview="imports" style="display:none">
                <div class="toolbar" style="margin-top:8px">
                  <button class="btn primary" id="btnNewImport">Th√™m phi·∫øu nh·∫≠p</button>
                  <input id="importFilter" type="date" />
                  <input id="importSearch" placeholder="T√¨m theo m√£ phi·∫øu" />
                </div>
                <div class="table-scroll" style="margin-top:8px">
                  <table id="tblImports"><thead><tr><th>STT</th><th>M√£ phi·∫øu</th><th>Ng√†y</th><th>T·ªïng m·∫∑t h√†ng</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody></tbody></table>
                </div>
              </div>

              <!-- Pricing -->
              <div data-subview="pricing" style="display:none">
                <div class="toolbar" style="margin-top:12px">
                  <select id="priceTypeFilter"><option value="">-- Ch·ªçn lo·∫°i ƒë·ªÉ ch·ªânh % --</option></select>
                  <input id="priceMargin" placeholder="% l·ª£i nhu·∫≠n (v√≠ d·ª• 20)" />
                  <button class="btn primary" id="btnSetMargin">√Åp d·ª•ng cho lo·∫°i</button>
                </div>
                <div class="table-scroll" style="margin-top:12px">
                  <table id="tblPricing"><thead><tr><th>STT</th><th>Xe ƒë·∫°p</th><th>Gi√° v·ªën</th><th>%LN</th><th>Gi√° b√°n</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody></tbody></table>
                </div>
              </div>

              <!-- Stock -->
              <div data-subview="stock" style="display:none">
                <div class="toolbar" style="margin-top:8px">
                  <select id="stockProductFilter"><option value="">-- Ch·ªçn xe ƒë·∫°p --</option></select>
                  <input id="stockFrom" type="date" />
                  <input id="stockTo" type="date" />
                  <button class="btn" id="btnCheckStock">Tra c·ª©u</button>
                  <button class="btn" id="btnLowStock">C·∫£nh b√°o s·∫Øp h·∫øt</button>
                </div>
                <div class="table-scroll" style="margin-top:8px">
                  <table id="tblStock"><thead><tr><th>STT</th><th>Xe ƒë·∫°p</th><th>Nh·∫≠p (t·ªïng)</th><th>Xu·∫•t (t·ªïng)</th><th>T·ªìn hi·ªán t·∫°i</th></tr></thead><tbody></tbody></table>
                </div>
              </div>

              <!-- Orders -->
              <div data-subview="orders" style="display:none">
                <div class="toolbar" style="margin-top:8px">
                  <input id="orderFrom_sub" type="date" />
                  <input id="orderTo_sub" type="date" />
                  <select id="orderStatus_sub"><option value="">-- Tr·∫°ng th√°i --</option><option value="new">M·ªõi ƒë·∫∑t</option><option value="processing">ƒê√£ x·ª≠ l√Ω</option><option value="shipped">ƒê√£ giao</option><option value="cancel">Hu·ª∑</option></select>
                  <button class="btn" id="btnFilterOrders_sub">T√¨m</button>
                  <button class="btn primary" id="btnNewOrder">Th√™m ƒë∆°n h√†ng</button>

                </div>
                <div class="table-scroll" style="margin-top:8px">
                  <table id="tblOrders_sub"><thead><tr><th>STT</th><th>M√£ ƒë∆°n</th><th>Ng√†y</th><th>T·ªïng ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody></tbody></table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Settings -->
        <section data-view="settings" style="display:none">
          <div class="card">
            <h3>C√†i ƒë·∫∑t</h3>
            <div class="small muted">M·ªôt s·ªë c·∫•u h√¨nh nhanh</div>
            <div style="margin-top:12px">
              <label>Ng∆∞·ª°ng c·∫£nh b√°o t·ªìn th·∫•p</label>
              <input id="lowThreshold" type="number" value="3" />
              <button class="btn" id="btnSaveSettings">L∆∞u</button>
            </div>
          </div>
        </section>
      </div>

      <div id="modal"><div id="modalCard"></div></div>
    </main>
  </div>

<script>
  let hasShownLowStockAlert = false;

/* ---------- Database (localStorage) ---------- */
const DB = {
  key: 'bikepro_admin_db_v1',
  defaultData(){
    
    return {
      users:[
        {id:1,name:'Kh√°ch A',email:'a@example.com',pass:'user',locked:false},
        {id:2,name:'Kh√°ch B',email:'b@example.com',pass:'user',locked:false},
        {id:99,name:'admin',email:'admin@bikepro.local',pass:'admin',locked:false,role:'admin'}
      ],
      types:[
        {id:1,name:'Xe ƒë·∫°p ƒë∆∞·ªùng tr∆∞·ªùng'},
        {id:2,name:'Xe ƒë·∫°p ƒë·ªãa h√¨nh'},
        {id:3,name:'Xe ƒë·∫°p g·∫•p'}
      ],
      products:[
        {id:1,code:'BD-TR-001',name:'RoadMaster Pro',type:1,desc:'Khung carbon, t·ªëc ƒë·ªô cao',cost:1200,stock:6,hidden:false,margin:15},
        {id:2,code:'BD-TR-002',name:'Sprint Elite',type:1,desc:'Khung nh√¥m, nh·∫π',cost:800,stock:4,hidden:false,margin:12},
        {id:3,code:'BD-MTB-001',name:'TrailBlazer X',type:2,desc:'MTB 29-inch, b·ªÅn',cost:900,stock:5,hidden:false,margin:14},
        {id:4,code:'BD-FOLD-001',name:'CityFold 20\"',type:3,desc:'G·∫•p g·ªçn, ph√π h·ª£p ƒë√¥ th·ªã',cost:450,stock:10,hidden:false,margin:10}
      ],
      imports:[], // {id, code, date, items:[{productId,qty,cost}], completed:boolean}
      orders:[
        {id:1,code:'O-2001',date:new Date().toISOString().slice(0,10),items:[{productId:1,qty:1,price:1380}],total:1380,status:'new'}
      ],
      stockHistory: [], // ‚úÖ L∆∞u l·ªãch s·ª≠ t·ªìn kho h·∫±ng ng√†y
      settings:{lowThreshold:3,defaultMargin:20}  

    }
  },
  load(){
    const raw = localStorage.getItem(this.key);
    if(!raw){ const d=this.defaultData(); localStorage.setItem(this.key,JSON.stringify(d)); return d; }
    return JSON.parse(raw);
  },
  save(db){ localStorage.setItem(this.key,JSON.stringify(db)); }
};

let db = DB.load();
let state = {user:null};
let warningThreshold = db.settings.lowThreshold || 3; // L·∫•y t·ª´ setting ho·∫∑c m·∫∑c ƒë·ªãnh l√† 3

/* ---------- Helpers ---------- */
const $ = (s,el=document) => el.querySelector(s);
const $$ = (s,el=document) => Array.from(el.querySelectorAll(s));
const uid = ()=> Date.now()+Math.floor(Math.random()*999);

/* ---------- Auth & UI ---------- */
function initAuth(){
  $('#btnLogin').addEventListener('click', ()=> {
    const u = $('#username').value.trim();
    const p = $('#password').value;
    const found = db.users.find(x => (x.name===u || x.email===u) && x.pass===p);
    if(found && !found.locked){ 
      state.user = found; 
      showApp();

      // üîî Hi·ªÉn th·ªã c·∫£nh b√°o t·ªìn kho ch·ªâ 1 l·∫ßn sau khi ƒëƒÉng nh·∫≠p
      const warningThreshold = 3; // v√≠ d·ª•: c·∫£nh b√°o khi h√†ng < 3
      const lowStock = db.products.filter(p => p.stock < warningThreshold);
      if (lowStock.length > 0) {
        alert(`‚ö†Ô∏è C√≥ ${lowStock.length} s·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng!\n` + 
              lowStock.map(p => `- ${p.name} (${p.stock} c√°i)`).join('\n'));
      }
    }
    else { 
      $('#loginMsg').textContent = found && found.locked ? 'T√†i kho·∫£n b·ªã kh√≥a' : 'Sai th√¥ng tin'; 
    }
  });

  $('#demoLogin').addEventListener('click', ()=>{ 
    $('#username').value='admin'; 
    $('#password').value='admin'; 
    $('#btnLogin').click(); 
  });

  $('#btnRestore').addEventListener('click', ()=> {
    if(!confirm('Kh√¥i ph·ª•c t√†i kho·∫£n admin? (M·∫≠t kh·∫©u s·∫Ω ƒë·∫∑t l·∫°i l√† "admin")')) return;
    const admin = db.users.find(u=>u.name==='admin' || u.email.includes('admin'));
    if(admin){ 
      admin.locked=false; 
      admin.pass='admin'; 
      DB.save(db); 
      alert('ƒê√£ kh√¥i ph·ª•c admin. ƒêƒÉng nh·∫≠p b·∫±ng admin / admin'); 
    }
    else { 
      db.users.push({id:uid(),name:'admin',email:'admin@bikepro.local',pass:'admin',locked:false,role:'admin'}); 
      DB.save(db); 
      alert('ƒê√£ t·∫°o m·ªõi admin'); 
    }
  });

  $('#btnLogout').addEventListener('click', ()=> {
    state.user = null; 
    $('#app').style.display='none'; 
    $('#loginWrap').style.display='flex'; 
    $('#loginMsg').textContent='';
  });

  $('#password').addEventListener('keyup', e => { if(e.key==='Enter') $('#btnLogin').click(); });
}


/* ---------- Show App & navigation ---------- */
function showApp(){
  $('#loginWrap').style.display='none'; $('#app').style.display='block'; $('#app').setAttribute('aria-hidden','false'); $('#who').textContent = state.user.name; renderAll();
}

/* sidebar nav */
$$('#menu button').forEach(btn => btn.addEventListener('click', ()=>{
  $$('#menu button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const view = btn.dataset.view; switchView(view);
}));
function switchView(v){
  $$('#views section').forEach(sec => sec.style.display = sec.dataset.view===v ? '' : 'none');
  $('#viewTitle').textContent = $$('#menu button').find(b=>b.dataset.view===v).textContent || v;
  if(v==='users') renderUsers();
  if(v==='types') renderTypes();
  if(v==='products') { activateSub('list'); renderProducts(); }
}

/* product subtabs */
$$('.subtabs button').forEach(b => b.addEventListener('click', ()=>{
  $$('.subtabs button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); activateSub(b.dataset.sub);
}));
function activateSub(name){
  $$('#subviews > div').forEach(d => d.style.display = d.dataset.subview === name ? '' : 'none');
  
  if (name === 'list') renderProducts();

  if (name === 'imports') {
    renderImports();
    recordDailyStock(); // ‚úÖ L∆∞u l·∫°i t·ªìn kho khi xem ho·∫∑c c·∫≠p nh·∫≠t phi·∫øu nh·∫≠p
  }

  if (name === 'pricing') renderPricing();

  if (name === 'stock') renderStock();

  if (name === 'orders') {
    renderOrders_sub();
    recordDailyStock(); // ‚úÖ L∆∞u l·∫°i t·ªìn kho khi x·ª≠ l√Ω ƒë∆°n h√†ng
  }
}

if (!db.types) db.types = [];
if (!db.products) db.products = [];

/* ---------- Renderers & Features ---------- */
function renderAll(){ renderDashboard(); renderUsers(); renderTypes(); renderProducts(); renderImports(); renderPricing(); renderOrders_sub(); renderStock(); }

/* Dashboard */
function renderDashboard(){
  $('#statProducts').textContent = db.products.length;
  $('#statStock').textContent = db.products.reduce((s,p)=>s+p.stock,0);
  $('#statOrders').textContent = db.orders.filter(o=>o.date===new Date().toISOString().slice(0,10)).length;
}

/* Users */
function renderUsers(filter=''){
  const tbody = $('#tblUsers tbody'); tbody.innerHTML='';
  const list = db.users.filter(u=>((u.name||'')+(u.email||'')).toLowerCase().includes(filter.toLowerCase()));
  list.forEach((u,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${u.name}</td><td>${u.email||''}</td><td>${u.locked?'<span class="badge lock">B·ªã kho√°</span>':'<span class="badge open">Ho·∫°t ƒë·ªông</span>'}</td><td><button class="btn" data-id="${u.id}" data-act="reset">Reset m·∫≠t kh·∫©u</button> <button class="btn" data-id="${u.id}" data-act="toggle">${u.locked? 'M·ªü kho√°' : 'Kho√°'}</button></td>`; tbody.appendChild(tr); });
  tbody.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{
    const id=Number(b.dataset.id), act=b.dataset.act, user=db.users.find(x=>x.id===id);
    if(!user) return;
    if(act==='reset'){ user.pass='user'; DB.save(db); alert('M·∫≠t kh·∫©u ƒë√£ reset v·ªÅ: user'); }
    if(act==='toggle'){ user.locked = !user.locked; DB.save(db); renderUsers($('#searchUser').value); }
  }));
}
$('#btnRefreshUsers')?.addEventListener('click', ()=>renderUsers(''));
$('#searchUser')?.addEventListener('input', e=>renderUsers(e.target.value));
$('#btnAddUser')?.addEventListener('click', ()=> {
  showModal(`<h3>Th√™m ng∆∞·ªùi d√πng</h3><label>T√™n</label><input id="mName"/><label>Email</label><input id="mEmail"/><label>M·∫≠t kh·∫©u</label><input id="mPass" value="user"/><div style="margin-top:8px"><button id="mSave" class="btn primary">L∆∞u</button> <button id="mCancel" class="btn">Hu·ª∑</button></div>`);
  $('#mSave').addEventListener('click', ()=>{ const n=$('#mName').value.trim(), e=$('#mEmail').value.trim(), p=$('#mPass').value; if(!n||!e){alert('Nh·∫≠p t√™n v√† email');return} db.users.push({id:uid(),name:n,email:e,pass:p,locked:false}); DB.save(db); closeModal(); renderUsers(); });
  $('#mCancel').addEventListener('click', closeModal);
});

/* Types */
function renderTypes(){
  const tbody = $('#tblTypes tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  (db.types || []).forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${t.name}</td><td>
      <button class="btn" data-id="${t.id}" data-act="edit">S·ª≠a</button>
      <button class="btn danger" data-id="${t.id}" data-act="delete">X√≥a</button>
    </td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = Number(b.dataset.id), act = b.dataset.act;
      const type = db.types.find(x=>x.id===id);
      if(!type) return;
      if(act==='edit'){
        const newName = prompt('Nh·∫≠p t√™n m·ªõi cho lo·∫°i:', type.name);
        if(!newName) return;
        type.name = newName;
        DB.save(db);
        renderTypes();
        renderProducts(); // c·∫≠p nh·∫≠t dropdown & hi·ªÉn th·ªã
      } else if(act==='delete'){
        if(!confirm(`X√≥a lo·∫°i "${type.name}"? S·∫£n ph·∫©m c√πng lo·∫°i s·∫Ω b·ªã b·ªè lo·∫°i.`)) return;
        // b·ªè li√™n k·∫øt type tr√™n s·∫£n ph·∫©m
        db.products.forEach(p => { if(p.type === id) p.type = null; });
        db.types = db.types.filter(x => x.id !== id);
        DB.save(db);
        renderTypes();
        renderProducts();
        alert('ƒê√£ x√≥a lo·∫°i v√† c·∫≠p nh·∫≠t s·∫£n ph·∫©m li√™n quan.');
      }
    });
  });
}
// ‚úÖ H√†m ƒë·ªãnh d·∫°ng gi√° ti·ªÅn ki·ªÉu Vi·ªát Nam
function formatVND(num) {
  if (num == null || isNaN(num)) return '0 ‚Ç´';
  return num.toLocaleString('vi-VN') + ' ‚Ç´';
}

/* Products */
/* Products */
function calcSell(p) {
  // L·∫•y % l·ª£i nhu·∫≠n s·∫£n ph·∫©m (p.margin) ho·∫∑c s·ª≠ d·ª•ng gi√° tr·ªã m·∫∑c ƒë·ªãnh c·ªßa C√ÄI ƒê·∫∂T
  const margin = p.margin != null ? p.margin : (db.settings.defaultMargin || 0);
  
  const sell = (p.cost || 0) * (1 + (margin || 0) / 100);
  return Math.round(sell); // lu√¥n l√†m tr√≤n
}
// === HI·ªÇN TH·ªä DANH S√ÅCH S·∫¢N PH·∫®M ===
// B·∫ÆT ƒê·∫¶U thay th·∫ø h√†m renderProducts hi·ªán t·∫°i c·ªßa b·∫°n

// === HI·ªÇN TH·ªä DANH S√ÅCH S·∫¢N PH·∫®M & L·ªåC CHUNG ===
// === HI·ªÇN TH·ªä DANH S√ÅCH S·∫¢N PH·∫®M & L·ªåC CHUNG ===
// === HI·ªÇN TH·ªä DANH S√ÅCH S·∫¢N PH·∫®M & L·ªåC CHUNG ===
function renderProducts() {
  const tbody = $('#tblProducts tbody');
  tbody.innerHTML = '';
  
  // L·∫•y gi√° tr·ªã l·ªçc hi·ªán t·∫°i
  const filterType = $('#filterType');
  const inputSearch = $('#searchProd');
  const selectedType = Number(filterType?.value) || null;
  const keyword = inputSearch?.value.trim().toLowerCase() || '';

  // --- 1. C·∫≠p nh·∫≠t Dropdown lo·∫°i s·∫£n ph·∫©m ---
  filterType.innerHTML = '<option value="">-- L·ªçc theo lo·∫°i --</option>';
  db.types.forEach(t => {
    const isSelected = selectedType === t.id; 
    filterType.innerHTML += `<option value="${t.id}" ${isSelected ? 'selected' : ''}>${t.name}</option>`;
  });
  
  // --- 2. L·ªçc danh s√°ch s·∫£n ph·∫©m ---
  const warningThreshold = db.settings.lowThreshold || 3;
  
  const filteredList = db.products.filter(p => {
    const matchType = selectedType ? p.type === selectedType : true;
    const matchSearch = (p.name + p.code).toLowerCase().includes(keyword);
    // Ch·ªâ hi·ªán s·∫£n ph·∫©m kh√¥ng ·∫©n (logic frontend)
    // N·∫øu ƒë√¢y l√† trang admin, ta hi·ªán t·∫•t c·∫£:
    return matchType && matchSearch; 
  });

  if (filteredList.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:gray">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ph√π h·ª£p.</td></tr>`;
    initProductActions(); // C·∫ßn g√°n l·∫°i listener ngay c·∫£ khi kh√¥ng c√≥ s·∫£n ph·∫©m
    return;
  }
  
  // --- 3. Render c√°c h√†ng s·∫£n ph·∫©m ---
  filteredList.forEach((p, i) => {
    const typeName = (db.types.find(t => t.id === p.type) || {}).name || '‚Äî';
    const tr = document.createElement('tr');

    let stockDisplay = p.stock;
    if (p.stock < warningThreshold) {
      stockDisplay = `<span style="color:#ff4d4d;font-weight:bold;">${p.stock} ‚ö†Ô∏è</span>`;
    }

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.code}</td>
      <td style="max-width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.name}</td>
      <td>${typeName}</td>
      <td>${formatVND(p.cost)}</td>
      <td>${formatVND(calcSell(p))}</td>
      <td>${stockDisplay}</td>
      <td>${p.hidden ? '·∫®n' : 'Hi·ªán'}</td>
      <td>
        <button class="btn info" data-id="${p.id}" data-act="view">Xem</button>
        <button class="btn" data-id="${p.id}" data-act="edit">S·ª≠a</button>
        <button class="btn warn" data-id="${p.id}" data-act="hide">·∫®n/Hi·ªán</button>
        <button class="btn danger" data-id="${p.id}" data-act="del">Xo√°</button>
      </td>`;

    tbody.appendChild(tr);
  });
  
  // --- 4. G√ÅN LISTENER CHO N√öT H√ÄNH ƒê·ªòNG (QUAN TR·ªåNG) ---
  tbody.querySelectorAll('button').forEach(b =>
    b.addEventListener('click', () => {
      const id = Number(b.dataset.id);
      const act = b.dataset.act;
      const p = db.products.find(x => x.id === id);
      if (!p) return;

      if (act === 'view') showProductDetail(p);
      if (act === 'edit') openProductModal(p);
      if (act === 'hide') {
        p.hidden = !p.hidden;
        DB.save(db);
        renderProducts();
      }
      if (act === 'del') {
        if (confirm('X√°c nh·∫≠n xo√° s·∫£n ph·∫©m?')) {
          db.products = db.products.filter(x => x.id !== id);
          DB.save(db);
          renderProducts();
        }
      }
    })
  );
  
  initProductActions(); // C·∫ßn g·ªçi ƒë·ªÉ g√°n c√°c listener cho input/button t√¨m ki·∫øm
}

function initProductActions() {
  const btnAdd = $('#btnAddProd');
  const btnSearch = $('#btnSearchProd');
  const btnShowAll = $('#btnShowAll');
  const inputSearch = $('#searchProd');
  const filterType = $('#filterType');

  // --- H√ÄM CHUNG K√çCH HO·∫†T L·ªåC ---
  const applyFilterAndSearch = () => {
    // G·ªçi h√†m renderProducts ƒë·ªÉ n√≥ th·ª±c hi·ªán l·ªçc v·ªõi keyword v√† type m·ªõi
    renderProducts();
  };

  // üü¢ N√∫t Th√™m s·∫£n ph·∫©m
  if (btnAdd) btnAdd.onclick = () => openProductModal();

  // üü¢ L·ªçc theo Lo·∫°i (Dropdown)
  if (filterType) {
    filterType.onchange = applyFilterAndSearch;
  }

  // üü¢ N√∫t T√¨m
  if (btnSearch) {
    btnSearch.onclick = applyFilterAndSearch;
  }
  
  // üü¢ Kh·∫Øc ph·ª•c l·ªói KH√îNG G√ï ƒê∆Ø·ª¢C CH·ªÆ V√Ä ENTER ƒë·ªÉ t√¨m
  if (inputSearch) {
    // 1. G√°n Listener cho s·ª± ki·ªán g√µ ch·ªØ (INPUT)
    // (ƒê√¢y l√† FIX L·ªñI ·ªê T√åM KI·∫æM C·ª¶A B·∫†N - N√≥ k√≠ch ho·∫°t t√¨m ki·∫øm khi b·∫°n g√µ)
    inputSearch.oninput = applyFilterAndSearch; 
    
    // 2. B·∫Øt s·ª± ki·ªán Enter (onkeypress)
    inputSearch.onkeypress = e => {
      if (e.key === 'Enter') {
        e.preventDefault(); // NgƒÉn submit form m·∫∑c ƒë·ªãnh
        applyFilterAndSearch();
      }
    };
  }
  
  // üü¢ Hi·ªÉn th·ªã t·∫•t c·∫£
  if (btnShowAll) {
    btnShowAll.onclick = () => {
      if (inputSearch) inputSearch.value = '';
      if (filterType) filterType.value = '';
      renderProducts(); // Render l·∫°i t·∫•t c·∫£
    };
  }
}


function openProductModal(p = null) {
  const isNew = !p;
  const typesOptions = (db.types || [])
    .map(
      t =>
        `<option value='${t.id}' ${
          p && p.type === t.id ? 'selected' : ''
        }>${t.name}</option>`
    )
    .join('');

  // S·ª≠a l·ªói: Th√™m n√∫t L∆ØU v√† HU·ª∂ v√†o cu·ªëi chu·ªói HTML
  showModal(`
    <h3>${isNew ? 'Th√™m' : 'S·ª≠a'} xe ƒë·∫°p</h3>
    <label>M√£</label>
    <input id='mCode' value='${p ? p.code : ''}'/>

    <label>T√™n</label>
    <input id='mName' value='${p ? p.name : ''}'/>

    <label>Lo·∫°i</label>
    <select id='mType'>${typesOptions}</select>

    <label>Gi√° v·ªën</label>
    <input id='mCost' type='number' value='${p ? p.cost : 0}'/>

    <label>T·ªìn</label>
    <input id='mStock' type='number' value='${p ? p.stock : 0}'/>

    <label>M√¥ t·∫£</label>
    <textarea id='mDesc'>${p ? p.desc : ''}</textarea>

    <label>H√¨nh ·∫£nh (URL ho·∫∑c ch·ªçn t·ªáp)</label>
    <input id='mImage' type='text' placeholder='D√°n link ·∫£nh ho·∫∑c ch·ªçn file b√™n d∆∞·ªõi' value='${p && p.image ? p.image : ''}'/>
    <input id='mFile' type='file' accept='image/*' style='margin-top:6px'/>

    <div style='margin-top:10px;text-align:center'>
      <img id='previewImg' src='${p && p.image ? p.image : 'https://via.placeholder.com/120x80?text=No+Img'}' 
           style='max-width:120px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.1)'/>
    </div>

    <label>% l·ª£i nhu·∫≠n (ƒë·ªÉ tr·ªëng d√πng: ${db.settings.defaultMargin || 0}% chung)</label>
    <input id='mMargin' type='number' 
           value='${p && p.margin != null ? p.margin : ''}'/>

    <div style="margin-top:12px">
      <button id="mSave" class="btn primary">üíæ L∆∞u</button>
      <button id="mCancel" class="btn">Hu·ª∑</button>
    </div>
  `); // <-- D·∫•u ƒë√≥ng ƒë√£ ƒë∆∞·ª£c ƒë∆∞a xu·ªëng cu·ªëi c√πng, bao g·ªìm c·∫£ n√∫t
  // --- X·ª≠ l√Ω khi ch·ªçn file ---
  $('#mFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev => {
        $('#previewImg').src = ev.target.result;
        $('#mImage').value = ev.target.result; // l∆∞u base64 v√†o input
      };
      reader.readAsDataURL(file);
    }
  });

  // --- L∆∞u s·∫£n ph·∫©m ---
  $('#mSave').addEventListener('click', () => {
    const code = $('#mCode').value.trim();
    const name = $('#mName').value.trim();
    const type = Number($('#mType').value);
    const cost = Number($('#mCost').value) || 0;
    const stock = Number($('#mStock').value) || 0;
    const desc = $('#mDesc').value;
    const image = $('#mImage').value.trim();
    const margin = $('#mMargin').value.trim();

    if (!code || !name) {
      alert('‚ö†Ô∏è Nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ v√† t√™n s·∫£n ph·∫©m!');
      return;
    }

    if (isNew) {
      db.products.push({
        id: uid(),
        code,
        name,
        type,
        cost,
        stock,
        desc,
        image,
        hidden: false,
        margin: margin === '' ? null : Number(margin),
      });
    } else {
      Object.assign(p, {
        code,
        name,
        type,
        cost,
        stock,
        desc,
        image,
        margin: margin === '' ? null : Number(margin),
      });
    }

    DB.save(db);
    closeModal();
    renderProducts();
    renderStock();
    renderPricing();
  });

  $('#mCancel').addEventListener('click', closeModal);
}

/* Imports (phi·∫øu nh·∫≠p) */
function renderImports(){
  const tbody=$('#tblImports tbody'); tbody.innerHTML='';
  db.imports.forEach((im,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${im.code||('IM-'+im.id)}</td><td>${im.date}</td><td>${im.items.length}</td><td>${im.completed? 'Ho√†n th√†nh':'M·ªõi'}</td><td><button class="btn" data-id="${im.id}" data-act="view">Xem</button> <button class="btn" data-id="${im.id}" data-act="edit">S·ª≠a</button> <button class="btn danger" data-id="${im.id}" data-act="del">Xo√°</button></td>`; tbody.appendChild(tr); });
  tbody.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{
    const id=Number(b.dataset.id), act=b.dataset.act, im=db.imports.find(x=>x.id===id);
    if(!im) return;
    if(act==='view') showImportView(im);
    if(act==='edit'){ if(im.completed){ alert('Phi·∫øu ƒë√£ ho√†n th√†nh, kh√¥ng th·ªÉ s·ª≠a'); return } openImportModal(im); }
    if(act==='del'){ if(!confirm('X√°c nh·∫≠n xo√°?')) return; db.imports=db.imports.filter(x=>x.id!==id); DB.save(db); renderImports(); renderStock(); }
  }));
}
$('#btnNewImport').addEventListener('click', ()=> openImportModal());

function openImportModal(im = null) {
  const isNew = !im;
  const prodOptions = db.products
    .map(p => `<option value='${p.id}'>${p.code} - ${p.name}</option>`)
    .join('');

  showModal(`
    <h3>${isNew ? 'Th√™m' : 'S·ª≠a'} phi·∫øu nh·∫≠p</h3>
    <label>Ng√†y</label>
    <input id='impDate' type='date' value='${im ? im.date : new Date().toISOString().slice(0, 10)}' />
    
    <label>Danh s√°ch s·∫£n ph·∫©m</label>
    <div id='impList'></div>
    
    <div style='margin-top:8px'>
      <select id='impAddSel'>${prodOptions}</select>
      <input id='impQty' type='number' placeholder='S·ªë l∆∞·ª£ng'/>
      <input id='impCost' type='number' placeholder='Gi√° nh·∫≠p (t·ª´ng xe)'/>
      <button id='impAdd' class='btn'>Th√™m</button>
    </div>

    <div style='margin-top:12px'>
      <button id='impSave' class='btn primary'>L∆∞u</button>
      <button id='impComplete' class='btn'>Ho√†n th√†nh</button>
      <button id='impCancel' class='btn'>Hu·ª∑</button>
    </div>
  `);

  const local = im
    ? JSON.parse(JSON.stringify(im))
    : {
        id: uid(),
        date: new Date().toISOString().slice(0, 10),
        items: [],
        completed: false,
        code: 'IM-' + Math.floor(Math.random() * 9000 + 1000),
      };

  // üü¢ T·ª∞ ƒê·ªòNG G√ÅN GI√Å V·ªêN KHI CH·ªåN S·∫¢N PH·∫®M
$('#impAddSel').addEventListener('change', () => {
  const pid = $('#impAddSel').value; // KH√îNG √©p ki·ªÉu Number
  const prod = db.products.find(p => p.id == pid); // d√πng so s√°nh ==
  if (prod) {
    $('#impCost').value = prod.cost || 0;
  }
});


  // üß© Danh s√°ch hi·ªán t·∫°i trong phi·∫øu
  function renderList() {
    $('#impList').innerHTML = local.items
      .map(
        (it, idx) => `
        <div style='padding:6px;border:1px solid rgba(255,255,255,0.03);margin-top:6px;border-radius:8px'>
          ${idx + 1}. ${(db.products.find(p => p.id === it.productId) || {}).name} 
          ‚Äî SL: ${it.qty} ‚Äî Gi√° nh·∫≠p: ${formatVND(it.cost)} 
          <button data-idx='${idx}' class='btn danger delItem'>Xo√°</button>
        </div>`
      )
      .join('');

    $$('.delItem').forEach(b =>
      b.addEventListener('click', () => {
        local.items.splice(Number(b.dataset.idx), 1);
        renderList();
      })
    );
  }

  renderList();

  // üü¢ N√∫t th√™m s·∫£n ph·∫©m v√†o phi·∫øu nh·∫≠p
  $('#impAdd').addEventListener('click', () => {
    const pid = Number($('#impAddSel').value);
    const q = Number($('#impQty').value) || 0;
    const c = Number($('#impCost').value) || 0;
    if (!pid || q <= 0) {
      alert('Ch·ªçn s·∫£n ph·∫©m & s·ªë l∆∞·ª£ng');
      return;
    }
    local.items.push({ productId: pid, qty: q, cost: c });
    renderList();
  });

  // üü¢ N√∫t l∆∞u phi·∫øu
  $('#impSave').addEventListener('click', () => {
    local.date = $('#impDate').value;
    if (isNew) {
      db.imports.push(local);
    } else {
      Object.assign(im, local);
    }
    DB.save(db);
    closeModal();
    renderImports();
    renderStock();
    renderPricing();
  });

  // üü¢ N√∫t ho√†n th√†nh phi·∫øu nh·∫≠p
  $('#impComplete').addEventListener('click', () => {
    if (local.items.length === 0) {
      alert('Phi·∫øu r·ªóng');
      return;
    }
    local.completed = true;
    local.items.forEach(it => {
      const p = db.products.find(x => x.id === it.productId);
      if (p) {
        p.stock = (p.stock || 0) + it.qty;
        p.cost = it.cost;
      }
    });
    if (isNew) db.imports.push(local);
    DB.save(db);
    closeModal();
    renderImports();
    renderStock();
    renderPricing();
    recordDailyStock();
  });

  $('#impCancel').addEventListener('click', closeModal);
}

function showImportView(im){ showModal(`<h3>Phi·∫øu nh·∫≠p ${im.code||''}</h3><div>Ng√†y: ${im.date}</div><div>Tr·∫°ng th√°i: ${im.completed? 'Ho√†n th√†nh':'M·ªõi'}</div><div style='margin-top:8px'>${im.items.map(it=>{const p=db.products.find(x=>x.id===it.productId); return `<div>${p? p.name : '‚Äî'} ‚Äî SL: ${it.qty} ‚Äî Gi√° nh·∫≠p: ${formatVND(it.cost)}</div>`
}).join('')}</div><div style='margin-top:8px'><button id='c' class='btn'>ƒê√≥ng</button></div>`); $('#c').addEventListener('click', closeModal); }


/* Pricing: set margin by type or by product override */
/* Pricing: set margin by type or by product override */
function renderPricing(){
  const tbody=$('#tblPricing tbody'); tbody.innerHTML='';
  
  db.products.forEach((p,i)=>{ 
    // 1. T√çNH L·ª¢I NHU·∫¨N ƒêANG √ÅP D·ª§NG
    const appliedMargin = p.margin != null ? p.margin : (db.settings.defaultMargin || 0);
    
    // 2. T√çNH GI√Å B√ÅN (s·ª≠ d·ª•ng h√†m calcSell ƒë√£ c√≥)
    const sell = calcSell(p); 
    
    const tr=document.createElement('tr'); 
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${p.name}</td>
      <td>${formatVND(p.cost)}</td>
      
      <td>${appliedMargin}%</td> 
      
      <td>${formatVND(sell)}</td>
      <td><button class="btn" data-id="${p.id}" data-act="edit">S·ª≠a %</button></td>
    `; 
    tbody.appendChild(tr); 
  });
  
  // --- G·∫Øn Listener cho n√∫t S·ª≠a % trong b·∫£ng Gi√° b√°n ---
  tbody.querySelectorAll('button').forEach(b=>b.addEventListener('click', ()=>{ 
    const id=Number(b.dataset.id), p=db.products.find(x=>x.id===id); 
    
    // ƒê·∫£m b·∫£o hi·ªÉn th·ªã gi√° tr·ªã Margin ƒëang ghi ƒë√®, n·∫øu kh√¥ng c√≥ th√¨ ƒë·ªÉ tr·ªëng
    const currentMargin = p.margin!=null? p.margin: '';
    
    showModal(`
      <h3>Ch·ªânh % l·ª£i nhu·∫≠n cho ${p.name}</h3>
      <label>% LN (√Åp d·ª•ng: ${db.settings.defaultMargin || 0}% n·∫øu ƒë·ªÉ tr·ªëng)</label>
      <input id='pm' type='number' value='${currentMargin}'/>
      <div style='margin-top:8px'>
        <button id='savePM' class='btn primary'>L∆∞u</button> 
        <button id='cpm' class='btn'>Hu·ª∑</button>
      </div>
    `); 
    
    $('#savePM').addEventListener('click', ()=>{ 
      const m = $('#pm').value.trim(); 
      p.margin = m===''? null: Number(m); // L∆∞u null n·∫øu ng∆∞·ªùi d√πng ƒë·ªÉ tr·ªëng
      DB.save(db); 
      closeModal(); 
      renderPricing(); 
      renderProducts(); 
    }); 
    $('#cpm').addEventListener('click', closeModal); 
  }));
  
  // --- Logic ch·ªânh Margin theo Lo·∫°i (Gi·ªØ nguy√™n) ---
  const sel=$('#priceTypeFilter'); sel.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i ƒë·ªÉ ch·ªânh % --</option>'; db.types.forEach(t=>sel.innerHTML += `<option value='${t.id}'>${t.name}</option>`);
  $('#btnSetMargin').onclick = ()=>{ 
    const typeId = Number($('#priceTypeFilter').value); 
    const margin = Number($('#priceMargin').value); 
    if(!typeId || isNaN(margin)){ alert('Ch·ªçn lo·∫°i & nh·∫≠p %'); return } 
    db.products.filter(p=>p.type===typeId).forEach(p=>p.margin = margin); 
    DB.save(db); 
    renderPricing(); 
    renderProducts(); 
  };
}

/* Orders (subview under products) */
/* Orders (subview under products) */
function renderOrders_sub() {
  // n√∫t t·∫°o ƒë∆°n (n·∫øu c√≥)
  $('#btnNewOrder')?.addEventListener('click', () => openOrderModal());

  const tbody = $('#tblOrders_sub tbody');
  tbody.innerHTML = '';

  // render h√†ng trong b·∫£ng
  (db.orders || []).forEach((o, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${o.code}</td>
      <td>${o.date}</td>
      <td>${formatVND(o.total || 0)}</td>
      <td>${o.status}</td>
      <td>
        <button class="btn" data-id="${o.id}" data-act="view">Xem</button>
        <button class="btn" data-id="${o.id}" data-act="update">C·∫≠p nh·∫≠t</button>
        <button class="btn danger" data-id="${o.id}" data-act="delete">X√≥a</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // --- C√°c h√†nh ƒë·ªông tr√™n c√°c n√∫t trong b·∫£ng ---
  tbody.querySelectorAll('button').forEach((b) =>
    b.addEventListener('click', () => {
      const id = Number(b.dataset.id);
      const act = b.dataset.act;
      const o = (db.orders || []).find((x) => x.id === id);
      if (!o) return;

      // XEM chi ti·∫øt
      if (act === 'view') {
        const details = (o.items || [])
          .map((it) => {
            const p = db.products.find((x) => x.id === it.productId);
            return `<div>${p ? p.name : '‚Äî'} ‚Äî SL: ${it.qty} ‚Äî Gi√°: ${formatVND(it.price)}</div>`;
          })
          .join('');

        showModal(`
          <h3>ƒê∆°n ${o.code}</h3>
          <div>Ng√†y: ${o.date}</div>
          <div>Tr·∫°ng th√°i: ${o.status}</div>
          <div style='margin-top:8px'>${details}</div>
          <div style='margin-top:8px;font-weight:bold'>T·ªïng ti·ªÅn: ${formatVND(o.total || 0)}</div>
          <div style='margin-top:8px'><button id='c' class='btn'>ƒê√≥ng</button></div>
        `);
        $('#c').addEventListener('click', closeModal);
        return;
      }

      // C·∫¨P NH·∫¨T tr·∫°ng th√°i
      if (act === 'update') {
        showModal(`
          <h3>C·∫≠p nh·∫≠t tr·∫°ng th√°i</h3>
          <select id='st'>
            <option value='new' ${o.status === 'new' ? 'selected' : ''}>M·ªõi ƒë·∫∑t</option>
            <option value='processing' ${o.status === 'processing' ? 'selected' : ''}>ƒê√£ x·ª≠ l√Ω</option>
            <option value='shipped' ${o.status === 'shipped' ? 'selected' : ''}>ƒê√£ giao</option>
            <option value='cancel' ${o.status === 'cancel' ? 'selected' : ''}>Hu·ª∑</option>
          </select>
          <div style='margin-top:8px'>
            <button id='s' class='btn primary'>üíæ L∆∞u</button>
            <button id='x' class='btn'>ƒê√≥ng</button>
          </div>
        `);

        $('#s').addEventListener('click', () => {
          const prev = o.status;
          o.status = $('#st').value;

          // N·∫øu chuy·ªÉn sang "ƒê√£ x·ª≠ l√Ω" => tr·ª´ t·ªìn kho
          if (prev !== 'processing' && o.status === 'processing') {
            (o.items || []).forEach((it) => {
              const p = db.products.find((x) => x.id === it.productId);
              if (p) p.stock = Math.max(0, (p.stock || 0) - it.qty);
            });
            alert(`üì¶ ƒê∆°n ${o.code} ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ‚Äî t·ªìn kho c·∫≠p nh·∫≠t.`);
          }

          // N·∫øu t·ª´ "ƒê√£ x·ª≠ l√Ω" v·ªÅ "Hu·ª∑" => ho√†n l·∫°i t·ªìn kho
          if (prev === 'processing' && o.status === 'cancel') {
            (o.items || []).forEach((it) => {
              const p = db.products.find((x) => x.id === it.productId);
              if (p) p.stock = (p.stock || 0) + it.qty;
            });
            alert(`üîÅ ƒê∆°n ${o.code} ƒë√£ b·ªã hu·ª∑ ‚Äî h√†ng ƒë∆∞·ª£c ho√†n l·∫°i t·ªìn kho.`);
          }

          DB.save(db);
          closeModal();
          renderOrders_sub();
          renderProducts();
          renderStock();
          renderDashboard();
        });

        $('#x').addEventListener('click', closeModal);
        return;
      }

      // X√ìA ƒë∆°n h√†ng
      if (act === 'delete') {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n ${o.code}?`)) return;

        // N·∫øu ƒë∆°n ƒëang "ƒê√£ x·ª≠ l√Ω" -> ho√†n l·∫°i t·ªìn kho tr∆∞·ªõc khi x√≥a
        if (o.status === 'processing') {
          (o.items || []).forEach((it) => {
            const p = db.products.find((x) => x.id === it.productId);
            if (p) p.stock = (p.stock || 0) + it.qty;
          });
        }

        db.orders = (db.orders || []).filter((x) => x.id !== id);
        DB.save(db);
        renderOrders_sub();
        renderProducts();
        renderStock();
        renderDashboard();
        alert(`‚úÖ ƒê√£ x√≥a ƒë∆°n ${o.code} th√†nh c√¥ng!`);
        return;
      }
    })
  );

  // --- (t√πy ch·ªçn) b·ªô l·ªçc: n·∫øu b·∫°n c√≥ c√°c input #orderFrom_sub, #orderTo_sub, #orderStatus_sub v√† n√∫t #btnFilterOrders_sub ---
  const btnFilter = $('#btnFilterOrders_sub');
  if (btnFilter) {
    btnFilter.onclick = () => {
      const from = $('#orderFrom_sub').value;
      const to = $('#orderTo_sub').value;
      const st = $('#orderStatus_sub').value;
      let list = (db.orders || []).slice();
      if (from) list = list.filter((o) => o.date >= from);
      if (to) list = list.filter((o) => o.date <= to);
      if (st) list = list.filter((o) => o.status === st);

      tbody.innerHTML = '';
      list.forEach((o, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${o.code}</td>
          <td>${o.date}</td>
          <td>${formatVND(o.total || 0)}</td>
          <td>${o.status}</td>
          <td><button class="btn" data-id="${o.id}" data-act="view">Xem</button></td>`;
        tbody.appendChild(tr);
      });

      // c·∫ßn bind l·∫°i listeners cho c√°c n√∫t m·ªõi
      tbody.querySelectorAll('button').forEach((b) =>
        b.addEventListener('click', () => {
          const id = Number(b.dataset.id);
          const o = (db.orders || []).find((x) => x.id === id);
          if (!o) return;
          showModal(`
            <h3>ƒê∆°n ${o.code}</h3>
            <div>Ng√†y: ${o.date}</div>
            <div>Tr·∫°ng th√°i: ${o.status}</div>
            <div style='margin-top:8px'>${(o.items||[]).map(it => {
              const p = db.products.find(x => x.id === it.productId);
              return `<div>${p? p.name:'‚Äî'} ‚Äî SL:${it.qty} ‚Äî Gi√°: ${formatVND(it.price)}</div>`;
            }).join('')}</div>
            <div style='margin-top:8px;font-weight:bold'>T·ªïng ti·ªÅn: ${formatVND(o.total||0)}</div>
            <div style='margin-top:8px'><button id='c' class='btn'>ƒê√≥ng</button></div>
          `);
          $('#c').addEventListener('click', closeModal);
        })
      );
    };
  }
}




// --- Modal t·∫°o / s·ª≠a ƒë∆°n ---
function openOrderModal(order = null) {
  const isNew = !order;
  if (!db.orders) db.orders = [];

  const prodOptions = db.products.map(p => `<option value="${p.id}">${p.code} - ${p.name}</option>`).join('');

  const html = `
    <div class="modal-content">
      <h3>${isNew ? 'T·∫°o' : 'S·ª≠a'} ƒë∆°n h√†ng</h3>
      <label>Ng√†y ƒë·∫∑t</label>
      <input id="ordDate" type="date" value="${order ? order.date : new Date().toISOString().slice(0, 10)}" />

      <label>Danh s√°ch s·∫£n ph·∫©m</label>
      <div id="ordList" style="max-height:200px;overflow-y:auto;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:6px;margin-top:4px"></div>

      <div style="margin-top:8px">
        <select id="ordAddSel">${prodOptions}</select>
        <input id="ordQty" type="number" placeholder="S·ªë l∆∞·ª£ng" />
        <button id="ordAdd" class="btn">Th√™m s·∫£n ph·∫©m</button>
      </div>

      <div style="margin-top:12px">
        <button id="ordSave" class="btn primary">üíæ L∆∞u ƒë∆°n h√†ng</button>
        <button id="ordCancel" class="btn">ƒê√≥ng</button>
      </div>
    </div>
  `;
  showModal(html);
  // G·∫Øn s·ª± ki·ªán sau khi modal ƒë√£ render xong
const waitForModal = setInterval(() => {
  if (document.querySelector('#ordAdd') && document.querySelector('#ordSave')) {
    clearInterval(waitForModal);
    attachOrderModalHandlers(order, isNew);
  }
}, 100);

}

function attachOrderModalHandlers(order, isNew) {
  console.log('‚úÖ Modal t·∫°o ƒë∆°n h√†ng ƒë√£ s·∫µn s√†ng');

  const local = order
    ? JSON.parse(JSON.stringify(order))
    : {
        id: uid(),
        code: 'O-' + Math.floor(Math.random() * 9000 + 1000),
        date: new Date().toISOString().slice(0, 10),
        items: [],
        total: 0,
        status: 'new',
      };

  function renderOrderItems() {
    $('#ordList').innerHTML =
      local.items.length === 0
        ? '<i style="color:gray">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</i>'
        : local.items.map((it, idx) => `
            <div style="padding:6px;border:1px solid rgba(255,255,255,0.05);margin-top:4px;border-radius:8px">
              ${idx + 1}. ${(db.products.find((p) => p.id === it.productId) || {}).name}
              ‚Äî SL: ${it.qty} ‚Äî Gi√°: ${formatVND(it.price)}
              <button data-idx="${idx}" class="btn danger delItem">Xo√°</button>
            </div>`).join('');
    $$('.delItem').forEach((b) =>
      b.addEventListener('click', () => {
        local.items.splice(Number(b.dataset.idx), 1);
        renderOrderItems();
      })
    );
  }

  renderOrderItems();

  $('#ordAdd').onclick = () => {
    const pid = Number($('#ordAddSel').value);
    const q = Number($('#ordQty').value);
    if (!pid || q <= 0) {
      alert('‚ö†Ô∏è Ch·ªçn s·∫£n ph·∫©m v√† nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá');
      return;
    }
    const p = db.products.find((x) => x.id === pid);
    if (!p) return alert('S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i');
    const price = calcSell(p);
    local.items.push({ productId: pid, qty: q, price });
    renderOrderItems();
    $('#ordQty').value = '';
  };

$('#ordSave').onclick = () => {
  local.date = $('#ordDate').value;
  local.total = local.items.reduce((sum, it) => sum + it.price * it.qty, 0);

  if (local.items.length === 0) {
    alert('‚ùó Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong ƒë∆°n!');
    return;
  }

  // üîπ Tr·ª´ t·ªìn kho ngay khi l∆∞u
  local.items.forEach(it => {
    const p = db.products.find(x => x.id === it.productId);
    if (p) p.stock = Math.max(0, (p.stock || 0) - it.qty);
  });

  if (isNew) db.orders.push(local);
  else Object.assign(order, local);

  DB.save(db);
  alert(`‚úÖ ƒê√£ l∆∞u ƒë∆°n h√†ng ${local.code} th√†nh c√¥ng!`);
  closeModal();
  renderOrders_sub();
  renderDashboard();
  renderStock();
};


$('#ordCancel').onclick = closeModal;
}




/* Stock */
function renderStock() {
  const tbody = $('#tblStock tbody');
  tbody.innerHTML = '';

  // ƒê·∫£m b·∫£o db c√≥ m·∫£ng c·∫ßn thi·∫øt
  if (!db.products) db.products = [];
  if (!db.stockHistory) db.stockHistory = [];

  // C·∫≠p nh·∫≠t dropdown danh s√°ch xe
  const sel = $('#stockProductFilter');
  sel.innerHTML = '<option value="">-- Ch·ªçn xe ƒë·∫°p --</option>';
  db.products.forEach(
    (p) => (sel.innerHTML += `<option value='${p.id}'>${p.name}</option>`)
  );

  // Hi·ªÉn th·ªã danh s√°ch t·ªïng qu√°t
  db.products.forEach((p, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.name}</td>
      <td>${calcTotalIn(p.id)}</td>
      <td>${calcTotalOut(p.id)}</td>
      <td>${p.stock}</td>`;
    tbody.appendChild(tr);
  });

  // C·∫£nh b√°o s·∫Øp h·∫øt h√†ng
  $('#btnLowStock').onclick = () => {
    const low = db.settings?.lowThreshold || 3;
    const list = db.products.filter((p) => p.stock <= low);
    if (list.length === 0) {
      alert('‚úÖ Kh√¥ng c√≥ xe n√†o s·∫Øp h·∫øt h√†ng!');
      return;
    }
    alert(
      '‚ö†Ô∏è Xe s·∫Øp h·∫øt h√†ng:\n' +
        list.map((p) => `${p.name} (t·ªìn: ${p.stock})`).join('\n')
    );
  };

  // N√∫t tra c·ª©u
  $('#btnCheckStock').onclick = () => {
    const pid = Number($('#stockProductFilter').value);
    const from = $('#stockFrom').value;
    const to = $('#stockTo').value;

    if (!pid) return alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m');
    if (!from || !to) return alert('Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian');

    const p = db.products.find((x) => x.id === pid);
    if (!p) return alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m');

    if (!db.stockHistory.length)
      return alert('Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho n√†o ƒë∆∞·ª£c ghi!');

    const records = db.stockHistory.filter(
      (d) => d.date >= from && d.date <= to
    );
    if (!records.length)
      return alert('Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn trong kho·∫£ng th·ªùi gian n√†y!');

    const first = records[0];
    const last = records[records.length - 1];

    const startStock =
      first.records.find((r) => r.productId === pid)?.stock ?? null;
    const endStock =
      last.records.find((r) => r.productId === pid)?.stock ?? null;

    if (startStock == null || endStock == null)
      return alert('Kh√¥ng ƒë·ªß d·ªØ li·ªáu t·ªìn cho kho·∫£ng th·ªùi gian n√†y!');

    const totalIn = calcTotalIn(pid, from, to);
    const totalOut = calcTotalOut(pid, from, to);

    alert(
      `üìä Xe ƒë·∫°p: ${p.name}\nT·ª´ ${from} ‚Üí ${to}\n` +
        `Nh·∫≠p: ${totalIn}\nXu·∫•t: ${totalOut}\n` +
        `T·ªìn ƒë·∫ßu k·ª≥: ${startStock}\nT·ªìn cu·ªëi k·ª≥: ${endStock}`
    );
  };
}




/* Settings */
$('#btnSaveSettings').onclick = ()=>{ db.settings.lowThreshold = Number($('#lowThreshold').value)||3; DB.save(db); alert('L∆∞u th√†nh c√¥ng'); };

/* Modal helpers */
function showModal(html){ $('#modalCard').innerHTML = html; $('#modal').style.display='flex'; }
function closeModal(){ $('#modal').style.display='none'; $('#modalCard').innerHTML=''; }

/* Init */
initAuth();
setTimeout(renderAll, 300);
// --- Ghi l·∫°i t·ªìn kho h·∫±ng ng√†y ---
// --- Ghi l·∫°i t·ªìn kho h·∫±ng ng√†y ---
function recordDailyStock() {
  const today = new Date().toISOString().slice(0, 10);
  if (!db.stockHistory.find(d => d.date === today)) {
    const records = db.products.map(p => ({ productId: p.id, stock: p.stock }));
    db.stockHistory.push({ date: today, records });
    DB.save(db);
    console.log("ƒê√£ ghi l·∫°i t·ªìn kho ng√†y " + today);
  }
}
recordDailyStock(); // g·ªçi h√†m khi m·ªü trang
// ‚úÖ Hi·ªÉn th·ªã s·∫£n ph·∫©m khi trang load
document.addEventListener("DOMContentLoaded", () => {
  renderProducts();
});

// If user already logged (useful in dev), auto show
const logged = localStorage.getItem('loggedInUser');
if(logged){
  const found = db.users.find(u=>u.name===logged || u.email===logged);
  if(found){ state.user = found; showApp(); }
}
// ... (ph·∫ßn m√£ tr∆∞·ªõc ƒë√≥ gi·ªØ nguy√™n, bao g·ªìm c√°c h√†m kh√°c nh∆∞ openImportModal, showImportView, v.v.)

// Th√™m hai h√†m n√†y ƒë·ªÉ t√≠nh t·ªïng nh·∫≠p v√† xu·∫•t
function calcTotalIn(pid, from, to) {
  let sum = 0;
  db.imports.forEach(im => {
    if (from && im.date < from) return;
    if (to && im.date > to) return;
    im.items.forEach(it => { if (it.productId === pid) sum += it.qty; });
  });
  return sum;
}

function calcTotalOut(pid, from, to) {
  let sum = 0;
  db.orders.forEach(o => {
    if (from && o.date < from) return;
    if (to && o.date > to) return;
    o.items.forEach(it => { if (it.productId === pid) sum += it.qty; });
  });
  return sum;
}

// H√†m renderStock (ƒë√£ s·ª≠a ƒë·ªÉ s·ª≠ d·ª•ng c√°c h√†m tr√™n)
function renderStock() {
  const tbody = document.querySelector('#tblStock tbody');
  if (!tbody) return;

  const rows = db.products.map((p, i) => `
    <tr>
      <td>${i + 1}</td>
      <td>${p.name}</td>
      <td>${calcTotalIn(p.id)}</td>     <!-- T·ªïng nh·∫≠p -->
      <td>${calcTotalOut(p.id)}</td>    <!-- T·ªïng xu·∫•t -->
      <td>${p.stock || 0}</td>          <!-- T·ªìn hi·ªán t·∫°i -->
    </tr>
  `).join('');

  tbody.innerHTML = rows;
}
/* ==========================
   üîó LI√äN K·∫æT LO·∫†I XE & S·∫¢N PH·∫®M
   ========================== */

// üîπ H√†m hi·ªÉn th·ªã danh s√°ch lo·∫°i xe ƒë·∫°p
function renderTypes() {
  const tbody = $('#tblTypes tbody');
  if (!tbody) return;

  tbody.innerHTML = '';
  db.types.forEach((t, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${t.name}</td>
      <td>
        <button class="btn" data-id="${t.id}" data-act="edit">S·ª≠a</button>
        <button class="btn danger" data-id="${t.id}" data-act="delete">X√≥a</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // --- Thao t√°c tr√™n lo·∫°i ---
  tbody.querySelectorAll('button').forEach(btn => {
    const id = Number(btn.dataset.id);
    const act = btn.dataset.act;

    btn.addEventListener('click', () => {
      const type = db.types.find(t => t.id === id);
      if (!type) return;

      // S·ª≠a t√™n lo·∫°i
      if (act === 'edit') {
        const newName = prompt('Nh·∫≠p t√™n m·ªõi cho lo·∫°i:', type.name);
        if (!newName) return;
        type.name = newName;
        DB.save(db);
        renderTypes();
        renderProducts(); // c·∫≠p nh·∫≠t dropdown s·∫£n ph·∫©m
      }

      // X√≥a lo·∫°i
      else if (act === 'delete') {
        if (!confirm(`X√≥a lo·∫°i "${type.name}"?`)) return;
        // C·∫≠p nh·∫≠t s·∫£n ph·∫©m thu·ªôc lo·∫°i ƒë√≥
        db.products.forEach(p => {
          if (p.type === id) p.type = null;
        });
        db.types = db.types.filter(t => t.id !== id);
        DB.save(db);
        renderTypes();
        renderProducts();
        alert('üóëÔ∏è ƒê√£ x√≥a lo·∫°i v√† c·∫≠p nh·∫≠t s·∫£n ph·∫©m li√™n quan.');
      }
    });
  });
}

// üîπ Th√™m lo·∫°i xe m·ªõi
$('#btnAddType')?.addEventListener('click', () => {
  const name = prompt('Nh·∫≠p t√™n lo·∫°i xe m·ªõi:');
  if (!name) return;
  db.types.push({ id: uid(), name });
  DB.save(db);
  renderTypes();
  renderProducts(); // c·∫≠p nh·∫≠t dropdown s·∫£n ph·∫©m
  alert('‚úÖ ƒê√£ th√™m lo·∫°i xe m·ªõi!');
});

// üîπ ƒê·ªìng b·ªô lo·∫°i v√† s·∫£n ph·∫©m (ƒë·∫£m b·∫£o d·ªØ li·ªáu h·ª£p l·ªá)
function syncProductTypes() {
  db.products.forEach(p => {
    const typeExists = db.types.some(t => t.id === p.type);
    if (!typeExists) p.type = null;
  });
  DB.save(db);
}

// G·ªçi khi kh·ªüi ƒë·ªông trang (n·∫øu c√≥)
if (db && db.types && db.products) {
  syncProductTypes();
}
function linkProductsByTypeName(){
  // v·ªõi m·ªói product n·∫øu p.type l√† null v√† c√≥ p.typeName, c·ªë map sang id
  db.products.forEach(p=>{
    if((p.type === null || p.type === undefined) && p.typeName){
      const t = db.types.find(x => x.name.toLowerCase() === (p.typeName||'').toLowerCase());
      if(t) p.type = t.id;
    }
  });
  DB.save(db);
  renderProducts();
}
function showProductDetail(p) {
  const typeName = (db.types.find(t => t.id === p.type) || {}).name || '‚Äî';
  const sellPrice = formatVND(calcSell(p));

  showModal(`
    <div style="text-align:center; padding:10px">
      <img src="${p.image || 'https://via.placeholder.com/300x200?text=No+Image'}"
           style="max-width:300px;border-radius:10px;object-fit:cover;margin-bottom:12px;">
      <h3 style="color:#4fc3f7">${p.name}</h3>
      <p><b>M√£:</b> ${p.code}</p>
      <p><b>Lo·∫°i xe:</b> ${typeName}</p>
      <p><b>Gi√° v·ªën:</b> ${formatVND(p.cost)}</p>
      <p><b>Gi√° b√°n:</b> ${sellPrice}</p>
      <p><b>T·ªìn kho:</b> ${p.stock}</p>
      <p><b>Tr·∫°ng th√°i:</b> ${p.hidden ? '·∫®n' : 'Hi·ªán'}</p>
      <p><b>M√¥ t·∫£:</b><br>${p.desc || '<i>Ch∆∞a c√≥ m√¥ t·∫£</i>'}</p>
      <div style="margin-top:10px">
        <button class="btn" id="closeDetail">ƒê√≥ng</button>
      </div>
    </div>
  `);

  $('#closeDetail').addEventListener('click', closeModal);
}


</script>
</body>
</html>
